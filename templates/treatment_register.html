<!DOCTYPE html>

<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }

    .header {
      font-size: 16px;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: #f4f6f8;
      margin: 0;
    }

    .container {
      font-size: 24px;
    }

    /* ================= HEADER ================= */
    .header {
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 40px;

      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #5b2c83;
    }

    .header-left i {
      font-size: 26px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .logout-btn {
      background: #ff6b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      font-size: 24px;
      background: #f4f6f9;
      margin: 0;
    }

    .box {
      position: relative;
      background: #fff;
      padding: 40px;
      border-radius: 14px;
      max-width: 1500px;
      margin: 40px auto;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    }

    .save-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: #28a745;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 18px;
      font-weight: 600;
    }

    h2 {
      margin-top: 10px;
      margin-bottom: 25px;
      font-size: 32px;
      font-weight: 700;
      text-align: center;
    }

    .search {
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 20px;
      font-size: 24px;
      border-radius: 14px;
      border: 1px solid #bbb;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 14px;
      overflow: hidden;
    }

    th,
    td {
      border: 1px solid #cfd8dc;
      padding: 12px;
      text-align: center;
    }

    th {
      background: #90CAF9;
      color: #0d47a1;
    }

    .action-btn {
      cursor: pointer;
      margin: 0 6px;
      font-size: 22px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .back-btn {
      margin-top: 25px;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: #e0e0e0;
      cursor: pointer;
      font-size: 20px;
    }

    /* ===== EDIT PAGE LAYOUT ===== */
    #page-edit form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 22px 40px;
      align-items: start;
    }

    #page-edit label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }

    #page-edit input,
    #page-edit select,
    #page-edit textarea {
      width: 100%;
      padding: 14px 16px;
      font-size: 22px;
      border-radius: 12px;
      border: 1px solid #b0bec5;
      box-sizing: border-box;
    }

    /* textarea ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ñ‡∏ß */
    #page-edit textarea {
      grid-column: 1 / -1;
    }

    /* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏≤ / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ñ‡∏ß */
    #page-edit .medicine-group {
      grid-column: 1 / -1;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≤ */
    #medicine_table th {
      background: #e3f2fd;
      color: #0d47a1;
    }

    /* ===== RADIO ALLERGY (‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô) ===== */
    .inline {
      grid-column: 1 / -1;
      display: flex;
      gap: 40px;
      align-items: center;
      margin-top: 5px;
    }

    .inline input[type="radio"] {
      transform: scale(1.8);
      margin-right: 10px;
      cursor: pointer;
    }

    .inline label {
      font-size: 22px;
      cursor: pointer;
    }

    /* ===== BUTTON ZONE ===== */
    .edit-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    .btn-save {
      background: #2196f3;
      color: #fff;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 22px;
      cursor: pointer;
    }

    .btn-cancel {
      background: #e53935;
      color: #fff;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 22px;
      cursor: pointer;
    }

    .btn-back {
      background: #9e9e9e;
      color: #fff;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 22px;
      cursor: pointer;
    }

    /* ================= FOOTER ================= */
    .footer {
      width: 100%;
      background: #dcdcdc;
      text-align: center;
      padding: 18px;
      font-size: 14px;
      color: #555;
      margin-top: 60px;
    }
  </style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>

    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <div class="container">
    <!-- ================= LIST ================= -->

    <div id="page-list" class="box page active">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π -->
      <div class="top-bar">
        <a href="/menu" class="save-btn">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
      </div>
      <h2>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
      <input type="text" id="searchInput" class="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" onkeyup="filterTable()">
      <table id="recordTable"></table>
    </div>

    <!-- ================= VIEW ================= -->

    <div id="page-view" class="box page">
      <a href="/treatment_menu" class="save-btn">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
      <h2>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
      <div id="viewBox"></div>
      <button class="back-btn" onclick="back()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </div>

    <!-- ================= EDIT ================= -->

    <div id="page-edit" class="box page">
      <a href="/treatment_menu" class="save-btn">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
      <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>

      <form id="editForm">

        <input type="hidden" id="edit_id">

        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
        <input type="date" name="visit_date" id="edit_date" required>

        <label>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
        <input type="text" name="patient_name" id="edit_name" required>

        <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
        <select name="department" id="edit_department">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option>‡∏≠‡∏™‡∏£.</option>
          <option>‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
          <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</option>
          <option>‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°</option>
          <option>‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
          <option>‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•</option>
          <option>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</option>
          <option>‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£</option>
          <option>‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
          <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>

        <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
        <select name="symptom_group" id="edit_symptom_group">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option value="respiratory">‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à</option>
          <option value="digestive">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
          <option value="muscle">‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠</option>
          <option value="brain">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á</option>
          <option value="skin">‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á</option>
          <option value="medicine">‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</option>
          <option value="urinary">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢</option>
          <option value="reproductive">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
          <option value="eye">‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å</option>
          <option value="throat">‡∏Ñ‡∏≠</option>
          <option value="nose">‡∏à‡∏°‡∏π‡∏Å</option>
          <option value="wound">‡∏ó‡∏≥‡πÅ‡∏ú‡∏•</option>
          <option value="work_accident">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏á‡∏≤‡∏ô</option>
          <option value="nonwork_accident">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏ô‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</option>
          <option value="supply">‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</option>
          <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
        <textarea name="symptom_detail" id="edit_symptom" rows="3"></textarea>
        <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</label>

        <div class="medicine-group">

          <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
            <select id="medicine_select" style="flex:3;">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
            </select>

            <input type="text" id="medicine_other" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå" style="flex:3; display:none;">

            <select id="lot_select" style="flex:2;">
              <option value="">Lot</option>
            </select>

            <input type="number" id="qty_input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" style="flex:1;">

            <button type="button" onclick="addMedicine()" style="flex:1;">
              ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
            </button>
          </div>

          <table width="100%" id="medicine_table"></table>

        </div>

        <label>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
        <div class="inline">
          <label><input type="radio" name="allergy" value="0"> ‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
          <label><input type="radio" name="allergy" value="1"> ‡∏°‡∏µ</label>
        </div>
        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
        <textarea name="allergy_detail" id="edit_allergy_detail" rows="2"></textarea>

        <!-- ===== ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå ===== -->
        <div style="grid-column:1 / -1; margin-top:30px;">

          <label style="font-size:26px; font-weight:700;">
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå
          </label>

          <label style="font-weight:500; margin-top:10px;">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
          </label>

          <div class="inline">
            <label>
              <input type="radio" name="occupational_disease" value="0">
              ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢
            </label>
            <label>
              <input type="radio" name="occupational_disease" value="1">
              ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢
            </label>
          </div>

          <label style="margin-top:15px;">
            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå
          </label>

          <textarea id="edit_doctor_opinion" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå"></textarea>

        </div>

        <div class="edit-actions">
          <button type="submit" class="btn-save">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button type="button" class="btn-cancel" onclick="back()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="button" class="btn-back" onclick="back()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>

      </form>
    </div>

    <script>
      /* ===============================
         TABLE RENDER (SQLite)
      ================================ */
      let allRecords = [];

      function safeText(v) {
        return (v === null || v === undefined || v === "") ? "-" : v;
      }

      function formatMeds(medicineText) {
        if (!medicineText) return "-";
        try {
          const items = JSON.parse(medicineText);
          if (!Array.isArray(items) || items.length === 0) return "-";
          return items.map(it => {
            const name = it.name || "-";
            const lot = it.lot || "";
            const qty = it.qty || "";
            return `${name}${lot ? " " + lot : ""}${qty ? " x" + qty : ""}`;
          }).join(", ");
        } catch (e) {
          return medicineText; // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON
        }
      }

      function renderTable(records) {
        const table = document.getElementById('recordTable');

        table.innerHTML = `
    <tr>
      <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
      <th>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</th>
      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    </tr>
  `;

        if (!records || records.length === 0) {
          table.innerHTML += `
      <tr>
        <td colspan="5" style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
      </tr>
    `;
          return;
        }

        records.forEach((r, i) => {
          table.innerHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${safeText(r.visit_date)}</td>
        <td>${safeText(r.patient_name)}</td>
        <td style="text-align:left">${formatMeds(r.medicine)}</td>
        <td>
          <span class="action-btn" onclick="viewRecord(${r.id})">üëÅÔ∏è</span>
          <span class="action-btn" onclick="editRecord(${r.id})">‚úèÔ∏è</span>
          <span class="action-btn" onclick="deleteRecord(${r.id})">üóëÔ∏è</span>
        </td>
      </tr>
    `;
        });
      }

      /* ===============================
         LOAD LIST (SQLite)
      ================================ */
      async function loadRecords() {
        const res = await fetch("/api/treatment_list");
        allRecords = await res.json();
        renderTable(allRecords);
      }

      function filterTable() {
        const q = (document.getElementById("searchInput").value || "").toLowerCase();
        const filtered = allRecords.filter(r =>
          (r.patient_name || "").toLowerCase().includes(q) ||
          (r.visit_date || "").includes(q) ||
          formatMeds(r.medicine).toLowerCase().includes(q)
        );
        renderTable(filtered);
      }

      /* ===============================
         PAGE SWITCH
      ================================ */
      function switchPage(id) {
        document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
        document.getElementById(id).classList.add("active");
      }
      function back() { switchPage("page-list"); }

      /* ===============================
         VIEW (SQLite)
      ================================ */
      function viewRecord(id) {
        fetch(`/api/treatment/${id}`)
          .then(res => res.json())
          .then(r => {
            if (!r.success) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const d = r.data;

            document.getElementById("viewBox").innerHTML = `
        <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</b> ${safeText(d.visit_date)}</p>
        <p><b>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</b> ${safeText(d.patient_name)}</p>
        <p><b>‡πÅ‡∏ú‡∏ô‡∏Å:</b> ${safeText(d.department)}</p>
        <p><b>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> ${safeText(d.symptom_group)}</p>
        <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> ${safeText(d.symptom_detail)}</p>
        <p><b>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå:</b> ${formatMeds(d.medicine)}</p>
        <p><b>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</b> ${d.allergy == 1 ? "‡∏°‡∏µ" : "‡πÑ‡∏°‡πà‡∏°‡∏µ"}</p>
        <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</b> ${safeText(d.allergy_detail)}</p>
        <p><b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå:</b> ${d.occupational_disease == 1 ? "‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢" : "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢"}</p>
        <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå:</b> ${safeText(d.doctor_opinion)}</p>
      `;
            switchPage("page-view");
          });
      }

      /* ===============================
         EDIT
      ================================ */
      let editMedicines = [];

      const edit_id = document.getElementById("edit_id");
      const edit_date = document.getElementById("edit_date");
      const edit_name = document.getElementById("edit_name");
      const edit_department = document.getElementById("edit_department");
      const edit_symptom_group = document.getElementById("edit_symptom_group");
      const edit_symptom = document.getElementById("edit_symptom");
      const edit_allergy_detail = document.getElementById("edit_allergy_detail");
      const edit_doctor_opinion = document.getElementById("edit_doctor_opinion");

      function renderMedicineTable() {
        const table = document.getElementById("medicine_table");
        table.innerHTML = `
    <tr>
      <th>‡∏¢‡∏≤</th><th>Lot</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏•‡∏ö</th>
    </tr>
  `;
        editMedicines.forEach((m, i) => {
          table.innerHTML += `
      <tr>
        <td>${safeText(m.name)}</td>
        <td>${safeText(m.lot)}</td>
        <td>${safeText(m.qty)}</td>
        <td>${safeText(m.price)}</td>
        <td><button type="button" onclick="removeMedicine(${i})">üóëÔ∏è</button></td>
      </tr>
    `;
        });
      }
      function removeMedicine(i) {
        editMedicines.splice(i, 1);
        renderMedicineTable();
      }

      function editRecord(id) {
        fetch(`/api/treatment/${id}`)
          .then(res => res.json())
          .then(r => {
            if (!r.success) {
              alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
              return;
            }
            const d = r.data;

            edit_id.value = d.id;
            edit_date.value = d.visit_date || "";
            edit_name.value = d.patient_name || "";
            edit_department.value = d.department || "";
            edit_symptom_group.value = d.symptom_group || "";
            edit_symptom.value = d.symptom_detail || "";
            edit_allergy_detail.value = d.allergy_detail || "";
            edit_doctor_opinion.value = d.doctor_opinion || "";

            const occ = document.querySelector(`input[name="occupational_disease"][value="${d.occupational_disease}"]`);
            if (occ) occ.checked = true;

            const al = document.querySelector(`input[name="allergy"][value="${d.allergy}"]`);
            if (al) al.checked = true;

            editMedicines = [];
            try { editMedicines = JSON.parse(d.medicine || "[]"); } catch (e) { }
            renderMedicineTable();

            switchPage("page-edit");
          })
          .catch(err => {
            console.error(err);
            alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          });
      }

      /* ===============================
         DELETE (SQLite)
      ================================ */
      function deleteRecord(id) {
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) return;

        fetch(`/api/treatment/delete/${id}`, { method: "DELETE" })
          .then(res => res.json())
          .then(async r => {
            if (!r.success) { alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); return; }
            alert("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
            await loadRecords();
            switchPage("page-list");
          });
      }

      /* ===============================
         INIT
      ================================ */
      document.addEventListener("DOMContentLoaded", () => {
        loadRecords();
      });

      /* ===============================
         ADD MEDICINE IN EDIT (use med_id + lots)
      ================================ */
      const medSelect = document.getElementById("medicine_select");
      const medOther = document.getElementById("medicine_other");
      const lotSelect = document.getElementById("lot_select");
      const qtyInput = document.getElementById("qty_input");

      /* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) */
      const medicineData = {
        respiratory: ['Amoxy', 'Bisolvon', 'Mybacin', 'Loratadine', 'Zyetec', 'M.tusis'],
        digestive: ['Air-x', 'K milk120cc', 'Buscopan', 'Diasgest', 'M.car', 'ORS', 'Paracetamol(500)', 'Motilium', 'K-milk', '‡∏¢‡∏≤‡∏´‡∏≠‡∏°', 'CA-R-Bon'],
        muscle: ['Balm', 'Mydoclam', 'Norgesic'],
        brain: ['B1,6,12', 'Dimen', 'ORS', 'Paracetamol(500)'],
        skin: ['Acyclovir', 'CPM', 'Loratadine', 'Zyetec', '0.1%TA Cream', 'Mycozol', 'Silver cream', 'Calamine lotion'],
        medicine: [],
        urinary: ['Paracetamol(500)', 'Norflox'],
        reproductive: ['Ponstan(500)'],
        eye: ['Hista oph', 'Op Sar', 'Ointment', 'Brufen(400)', 'Kenalog'],
        throat: [],
        nose: [],
        wound: ['Plaster', '‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ'],
        work_accident: [],
        nonwork_accident: [],
        supply: [
          '‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ', 'EB:3', 'EB:2', 'Mask', 'Grove Dispose', 'Eyepad',
          'Transpore', 'Sofatulle', '‡πÑ‡∏°‡πâ‡∏Å‡∏î‡∏•‡∏¥‡πâ‡∏ô', 'Gouze', 'Betadine',
          '70%Alcohol', '0.9%NSS', 'Amora'
        ],
        other: []
      };

      edit_symptom_group.addEventListener("change", () => {
        medSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';
        lotSelect.innerHTML = '<option value="">Lot</option>';
        medSelect.style.display = 'block';
        medOther.style.display = 'none';

        if (edit_symptom_group.value === 'other') {
          medSelect.style.display = 'none';
          medOther.style.display = 'block';
          return;
        }

        (medicineData[edit_symptom_group.value] || []).forEach(item => {
          const opt = document.createElement("option");
          opt.value = item;
          opt.textContent = item;
          medSelect.appendChild(opt);
        });
      });

      /* ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÇ‡∏´‡∏•‡∏î LOT ‡∏î‡πâ‡∏ß‡∏¢ medicine_id (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô form) */
      medSelect.addEventListener("change", async () => {
        lotSelect.innerHTML = '<option value="">Lot</option>';
        if (!medSelect.value) return;

        try {
          const resId = await fetch(`/api/medicine_id?name=${encodeURIComponent(medSelect.value)}`);
          const dataId = await resId.json();
          const medId = dataId.medicine_id;

          if (!medId) {
            console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö medicine_id:", medSelect.value);
            return;
          }

          const resLots = await fetch(`/api/medicine_lots?medicine_id=${medId}`);
          const dataLots = await resLots.json();

          (dataLots.lots || []).forEach(lot => {
            const opt = document.createElement("option");
            opt.value = lot.id;
            opt.textContent = `${lot.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${lot.remain})`;
            opt.dataset.price = lot.price || 0;
            lotSelect.appendChild(opt);
          });

        } catch (err) {
          console.error(err);
          alert("‡πÇ‡∏´‡∏•‡∏î Lot ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
      });

      function addMedicine() {
        const name = medSelect.value || medOther.value;
        const lotText = lotSelect.options[lotSelect.selectedIndex]?.text || "";
        const lotId = lotSelect.value;
        const qty = parseInt(qtyInput.value, 10);

        if (!name || !lotId || !qty) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
          return;
        }

        editMedicines.push({
          name: name,
          lot: lotText,
          lot_id: lotId,
          qty: qty,
          price: lotSelect.options[lotSelect.selectedIndex].dataset.price || "-"
        });

        renderMedicineTable();
        qtyInput.value = "";
        lotSelect.innerHTML = '<option value="">Lot</option>';
      }

      /* ===============================
         SUBMIT EDIT
      ================================ */
      document.getElementById("editForm").addEventListener("submit", e => {
        e.preventDefault();

        fetch(`/api/treatment/edit/${edit_id.value}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            visit_date: edit_date.value,
            patient_name: edit_name.value,
            department: edit_department.value,
            symptom_group: edit_symptom_group.value,
            symptom_detail: edit_symptom.value,
            medicine: JSON.stringify(editMedicines),
            allergy: document.querySelector('input[name="allergy"]:checked').value,
            allergy_detail: edit_allergy_detail.value,
            occupational_disease: document.querySelector('input[name="occupational_disease"]:checked').value,
            doctor_opinion: edit_doctor_opinion.value
          })
        })
          .then(res => res.json())
          .then(async r => {
            if (!r.success) {
              alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
              return;
            }
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            await loadRecords();
            switchPage("page-list");
          });
      });

      /* ===============================
         INIT
      ================================ */
      document.addEventListener("DOMContentLoaded", () => {
        loadRecords(); // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      });
    </script>

    <!-- ===== FOOTER ===== -->
    <div class="footer">
      ¬© 2025 Safety Officer, CPF Khon Kaen Feedmill
    </div>
</body>

</html>