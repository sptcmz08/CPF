<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      font-size: 16px;
      /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÄ‡∏ó‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ */
    }

    h2 {
      font-size: 32px;
      /* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà */
    }

    h4 {
      font-size: 20px;
    }

    .menu-item {
      font-size: 18px;
    }

    .graph-box,
    table,
    .scroll-item {
      font-size: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: #f4f6f8;
      margin: 0;
    }

    /* ================= HEADER ================= */
    .header {
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #5b2c83;
    }

    .header-left i {
      font-size: 26px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .logout-btn {
      background: #ff6b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    /* ================= CONTAINER ================= */
    .container {
      max-width: 1500px;
      /* ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
      background: #ffffff;
      margin: 40px auto;
      /* ‚≠ê ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ */
      padding: 40px;
      border-radius: 14px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
      position: relative;
    }

    .back-menu {
      position: absolute;
      top: 15px;
      left: 15px;
      background: #28a745;
      color: #fff;
      padding: 8px 14px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      font-weight: bold;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    /* ================= MENU ================= */
    .top-menu {
      display: flex;
      border-bottom: 2px solid #ddd;
    }

    .menu-item {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    .menu-item.active {
      background: #ffe5e5;
      border-bottom: 3px solid #ff5a5a;
    }

    .back-btn {
      display: none;
      cursor: pointer;
      color: #2c7be5;
      font-weight: bold;
      margin: 10px 0;
    }

    /* ================= SCROLL ================= */
    .scroll-bar {
      display: none;
      overflow-x: auto;
      white-space: nowrap;
      margin: 10px 0;
    }

    .scroll-item {
      display: inline-block;
      padding: 6px 14px;
      margin-right: 8px;
      border-radius: 20px;
      background: #eee;
      cursor: pointer;
      font-size: 14px;
    }

    .scroll-item.active {
      background: #2c7be5;
      color: #fff;
    }

    /* ================= SECTION ================= */
    .section {
      display: none;
    }

    .show {
      display: block;
    }

    .graph-box {
      margin-top: 15px;
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
    }

    .footer {
      width: 100%;
      background: #dcdcdc;
      text-align: center;
      padding: 18px;
      font-size: 14px;
      color: #555;
      margin-top: 60px;
      /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏à‡∏≤‡∏Å container */
    }

    .dashboard-row {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .dashboard-left {
      flex: 2;
    }

    .dashboard-right {
      flex: 1;
    }

    html,
    body {
      width: 100%;
      overflow-x: hidden;
    }

    /* ================= TABLE STYLE ================= */
    .drug-table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Sarabun', sans-serif;
      font-size: 18px;
      /* üî† ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
    }

    .drug-table th {
      background: #4da3ff;
      /* üîµ ‡∏ü‡πâ‡∏≤‡∏ä‡∏±‡∏î */
      color: #ffffff;
      padding: 14px;
      border: 1px solid #cfd8dc;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
    }

    .drug-table td {
      padding: 12px;
      border: 1px solid #ddd;
      font-size: 17px;
    }

    .drug-table tr:nth-child(even) {
      background: #f9fbff;
    }

    /* ================= MONTH (SCROLL) ================= */
    .scroll-item {
      padding: 10px 22px;
      /* üóì ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
      font-size: 18px;
      /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà */
      border-radius: 24px;
    }

    .scroll-item.active {
      background: #2c7be5;
      color: #fff;
      font-weight: 600;
    }

    .back-btn {
      display: none !important;
    }

    /* ‚úÖ ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ */
    #monthTop5Chart {
      height: 260px !important;
    }

    #deptChart {
      height: 340px !important;
    }

    #diseaseChart {
      height: 340px !important;
    }

    /* ===== chart sizing helpers ===== */
    .chart-wrap {
      position: relative;
      width: 100%;
    }

    /* ‚úÖ Top5 ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡∏û‡∏≠‡∏î‡∏µ 5 ‡πÅ‡∏ó‡πà‡∏á */
    .chart-wrap-top5 {
      height: 260px;
    }

    /* ‚úÖ ‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    .chart-wrap-sm {
      height: 420px;
    }

    /* ‚úÖ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
    .chart-title {
      margin: 0 0 12px 0;
      font-size: 24px;
      font-weight: 700;
    }
  </style>
</head>

<body>

  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>
    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <!-- ===== CONTAINER ===== -->
  <div class="container">

    <a href="/menu" class="back-menu">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π</a>
    <h2>Dashboard ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</h2>

    <!-- ===== MENU ===== -->
    <div class="top-menu">
      <div class="menu-item active" onclick="openSection('top5',this)">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≤</div>
      <div class="menu-item" onclick="openSection('month',this)">‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
      <div class="menu-item" onclick="openSection('year',this)">‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</div>
      <div class="menu-item" onclick="openSection('cost',this)">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
    </div>

    <div class="back-btn" id="backBtn" onclick="goBack()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
    <div class="scroll-bar" id="scrollBar"></div>

    <!-- ===== TOP5 ===== -->
    <div id="top5" class="section show">
      <div class="graph-box">
        <table class="drug-table">
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</th>
              <th>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</th>
              <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
            </tr>
          </thead>
          <tbody id="drugTable"></tbody>
        </table>

      </div>
    </div>


    <div id="month" class="section">
      <div class="graph-box">
        <h4>üíä Top 5 ‡∏¢‡∏≤ / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h4>
        <div class="chart-wrap chart-wrap-top5">
          <canvas id="monthTop5Chart"></canvas>
        </div>
      </div>


      <div class="graph-box">
        <div class="dashboard-row">
          <div class="dashboard-left">
            <h3 class="chart-title">üè≠ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h3>
            <div class="chart-wrap chart-wrap-sm">
              <canvas id="deptChart"></canvas>
            </div>
          </div>

          <div class="dashboard-left">
            <h3 class="chart-title">ü©∫ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h3>
            <div class="chart-wrap chart-wrap-sm">
              <canvas id="diseaseChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>



    <div id="year" class="section">

      <div class="graph-box">
        <h4>üíä Top 5 ‡∏¢‡∏≤ / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</h4>
        <div class="chart-wrap chart-wrap-top5">
          <canvas id="yearTop5Chart"></canvas>
        </div>
      </div>

      <div class="graph-box">
        <div class="dashboard-row">
          <div class="dashboard-left">
            <h3 class="chart-title">üè≠ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</h3>
            <div class="chart-wrap chart-wrap-sm">
              <canvas id="yearDeptChart"></canvas>
            </div>
          </div>

          <div class="dashboard-left">
            <h3 class="chart-title">ü©∫ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</h3>
            <div class="chart-wrap chart-wrap-sm">
              <canvas id="yearDiseaseChart"></canvas>
            </div>
          </div>
        </div>
      </div>

    </div>


    <!-- ================== COST ================== -->
    <div id="cost" class="section">
      <div class="dashboard-row">

        <!-- ‡∏ã‡πâ‡∏≤‡∏¢ -->
        <div class="dashboard-right">
          <div class="graph-box" style="text-align:center;">
            <h4>üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
            <div id="sumTotal" style="font-size:26px;font-weight:700;color:#d32f2f;">0 ‡∏ö‡∏≤‡∏ó</div>
            <hr style="margin:15px 0">
            <h4>üíä ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤‡∏£‡∏ß‡∏°</h4>
            <div id="sumDrug" style="font-size:22px;font-weight:700;color:#388e3c;">0 ‡∏ö‡∏≤‡∏ó</div>
            <h4>üì¶ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏£‡∏ß‡∏°</h4>
            <div id="sumSupply" style="font-size:22px;font-weight:700;color:#1976d2;">0 ‡∏ö‡∏≤‡∏ó</div>
          </div>
        </div>

        <!-- ‡∏Ç‡∏ß‡∏≤ -->
        <div class="dashboard-left">
          <div class="graph-box" style="height:420px;">
            <canvas id="monthlyCostChart"></canvas>
          </div>
        </div>

      </div>
    </div>

  </div><!-- ‚úÖ container ‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->


  <script>

    /* ===== MENU ===== */
    function openSection(name, el) {
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      el.classList.add('active');

      document.querySelectorAll('.section').forEach(s => s.classList.remove('show'));
      document.getElementById(name).classList.add('show');

      document.getElementById('backBtn').style.display = name !== 'top5' ? 'block' : 'none';

      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ó‡πá‡∏ö "‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà ‡∏°.‡∏Ñ ‡πÄ‡∏™‡∏°‡∏≠
      if (name === "month") {
        currentMonth = 1;
      }

      setupScroll(name);

      // ‚úÖ ‡∏™‡∏±‡πà‡∏á render ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡πá‡∏ö
      if (name === "month") {
        renderTop5Month(currentMonth);
        renderMonthCharts(currentYear, currentMonth);
      }

      if (name === "year") {
        renderYearTop5();
        renderYearCharts(currentYear);
      }

      if (name === "cost") {
        ensureCostReady();
      }
    }

    function goBack() { document.querySelectorAll('.menu-item')[0].click(); }

    /* ===== SCROLL ===== */
    function setupScroll(type) {
      const bar = document.getElementById("scrollBar");
      bar.innerHTML = "";

      if (type === "year") {
        bar.style.display = "none";
        return;
      }

      bar.style.display = "block";

      const activeIndex = Math.max(0, (currentMonth || 1) - 1);

      ["‡∏°.‡∏Ñ", "‡∏Å.‡∏û", "‡∏°‡∏µ.‡∏Ñ", "‡πÄ‡∏°.‡∏¢", "‡∏û.‡∏Ñ", "‡∏°‡∏¥.‡∏¢", "‡∏Å.‡∏Ñ", "‡∏™.‡∏Ñ", "‡∏Å.‡∏¢", "‡∏ï.‡∏Ñ", "‡∏û.‡∏¢", "‡∏ò.‡∏Ñ"]
        .forEach((m, i) => {
          bar.innerHTML += `<span class="scroll-item ${i === activeIndex ? 'active' : ''}"
        onclick="changeMonth(${i},this)">${m}</span>`;
        });
    }


    /* ================= COST DATA ================= */
    let costCache = null;          // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ
    let monthlyCostChart = null;   // chart instance

    const monthLabels = ["‡∏°.‡∏Ñ", "‡∏Å.‡∏û", "‡∏°‡∏µ.‡∏Ñ", "‡πÄ‡∏°.‡∏¢", "‡∏û.‡∏Ñ", "‡∏°‡∏¥.‡∏¢", "‡∏Å.‡∏Ñ", "‡∏™.‡∏Ñ", "‡∏Å.‡∏¢", "‡∏ï.‡∏Ñ", "‡∏û.‡∏¢", "‡∏ò.‡∏Ñ"];

    function fmtBaht(n) {
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { maximumFractionDigits: 2 }) + " ‡∏ö‡∏≤‡∏ó";
    }

    async function loadCostYear(year) {
      try {
        const res = await fetch(`/api/dashboard/monthly_cost?year=${year}`);
        const json = await res.json();
        costCache = json.months || [];
      } catch (e) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
        costCache = [];
      }
    }

    function updateCostSummary(monthIndex0) { // 0-11
      const m = (costCache && costCache[monthIndex0]) ? costCache[monthIndex0] : { drug: 0, supply: 0, total: 0 };
      document.getElementById("sumDrug").innerText = fmtBaht(m.drug);
      document.getElementById("sumSupply").innerText = fmtBaht(m.supply);
      document.getElementById("sumTotal").innerText = fmtBaht(m.total);
    }

    function renderCostChart() {
      const drugData = (costCache || []).map(x => x.drug || 0);
      const supplyData = (costCache || []).map(x => x.supply || 0);

      const ctx = document.getElementById("monthlyCostChart");

      if (monthlyCostChart) {
        monthlyCostChart.destroy();
      }

      monthlyCostChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: monthLabels,
          datasets: [
            { label: "‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤", data: drugData },
            { label: "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå", data: supplyData }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } }
        }
      });
    }

    /* ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ó‡πá‡∏ö cost ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏µ */
    async function ensureCostReady() {
      if (!costCache) {
        await loadCostYear(currentYear);
        renderCostChart();
      }
      // currentMonth ‡πÄ‡∏õ‡πá‡∏ô 1-12
      updateCostSummary(currentMonth - 1);
    }
  </script>


  <script>
    /* ================== DASHBOARD DATA ================== */
    /* ‚úÖ GLOBAL STATE ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡∏õ‡∏µ ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    let currentMonth = 1;
    let currentYear = new Date().getFullYear(); // ‚úÖ ‡∏õ‡∏µ‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏ä‡πà‡∏ô 2026


    /* ================== CHANGE MONTH (‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö) ================== */
    function changeMonth(i, el) {

      // active UI
      document.querySelectorAll('.scroll-item')
        .forEach(m => m.classList.remove('active'));
      el.classList.add('active');

      // ‡πÅ‡∏õ‡∏•‡∏á index ‚Üí ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á
      currentMonth = i + 1;


      // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≤ / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå
      loadDrugTable(currentMonth, currentYear);

      // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ cost ‚Üí ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
      if (document.getElementById("cost").classList.contains("show")) {
        ensureCostReady();           // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏µ + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      }


      // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ month ‚Üí top5 ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      if (document.getElementById("month").classList.contains("show")) {
        renderTop5Month(currentMonth);
        renderMonthCharts(currentYear, currentMonth);
      }

    }
    const palette = [
      '#A7C7E7', '#B5EAD7', '#FFDAC1', '#E2CFEA', '#CDB4DB',
      '#FFC8DD', '#BDE0FE', '#D0F4DE', '#F1FAEE', '#FAEDCD'
    ];

    const departments = [
      "‡∏≠‡∏™‡∏£", "‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö", "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£", "‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°", "‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£",
      "‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•", "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£", "‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå"
    ];

    const diseases = [
      "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à", "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á", "‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á",
      "‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°", "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå", "‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å", "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
    ];

    function rand(len, max) {
      return Array.from({ length: len }, () => Math.floor(Math.random() * max) + 20);
    }

    /* ================== MONTH CHART (REAL DATA) ================== */
    let deptChart = null;
    let diseaseChart = null;

    const deptMaster = [
      "‡∏≠‡∏™‡∏£", "‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö", "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£", "‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°", "‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£",
      "‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•", "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£", "‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå"
    ];

    const symptomMaster = [
      "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à", "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á", "‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á",
      "‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°", "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå", "‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å", "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏", "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
    ];

    function normKey(s) {
      return String(s || "").trim().replace(/\s+/g, " ");
    }

    async function renderMonthCharts(year, month) {
      // ----- master list (‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß) -----
      const deptMaster = [
        "‡∏≠‡∏™‡∏£", "‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö", "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£", "‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°", "‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£",
        "‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•", "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£", "‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå"
      ];

      const symptomMaster = [
        "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à", "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á", "‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á",
        "‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°", "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå", "‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å", "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏", "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
      ];

      // ‡∏Å‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏´‡∏•‡∏∏‡∏î‡∏°‡∏≤ -> ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢
      const symptomAliasToThai = {
        "respiratory": "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à",
        "digestive": "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
        "muscle": "‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠",
        "brain": "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á",
        "skin": "‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á",
        "internal medicine": "‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°",
        "urinary": "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢",
        "reproductive": "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå",
        "eye ear mouth": "‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å",
        "accident": "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏",
        "wound": "‡∏ó‡∏≥‡πÅ‡∏ú‡∏•",
        "other": "‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
        "supply": "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå",
        "supplies": "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå"   // ‚úÖ ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      };

      function normDeptName(s) {
        return String(s || "")
          .trim()
          .replace(/\./g, "")   // ‡πÄ‡∏≠‡∏≤‡∏à‡∏∏‡∏î‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡∏™‡∏£." -> "‡∏≠‡∏™‡∏£"
          .replace(/\s+/g, " "); // ‡∏Å‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ     
      }

      function normKey(s) {
        return String(s || "").trim().toLowerCase().replace(/\s+/g, " ");
      }

      function toThaiSymptom(name) {
        const k = normKey(name);
        return symptomAliasToThai[k] || String(name || "").trim();
      }

      // 1) ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡∏à‡∏£‡∏¥‡∏á
      let deptData = [];
      let symptomData = [];

      try {
        const res = await fetch(`/api/dashboard/dept_month?year=${year}&month=${month}`);
        deptData = await res.json();
      } catch (e) {
        console.error("‡πÇ‡∏´‡∏•‡∏î dept ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
        deptData = [];
      }

      try {
        const res = await fetch(`/api/dashboard/symptom_month?year=${year}&month=${month}`);
        symptomData = await res.json();
      } catch (e) {
        console.error("‡πÇ‡∏´‡∏•‡∏î symptom ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
        symptomData = [];
      }

      // 2) ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏•‡∏á master list ‡πÅ‡∏•‡πâ‡∏ß "‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ" = 0
      const deptMap = {};
      (deptData || []).forEach(x => {
        const k = normDeptName(x.name);
        if (!k) return;
        deptMap[k] = (deptMap[k] || 0) + Number(x.total || 0);
      });

      const symMap = {};
      (symptomData || []).forEach(x => {
        const thaiName = toThaiSymptom(x.name);
        const k = String(thaiName || "").trim();
        if (!k) return;
        symMap[k] = (symMap[k] || 0) + Number(x.total || 0);
      });


      const deptLabels = deptMaster.map(normDeptName);
      const deptValues = deptMaster.map(n => Number(deptMap[n] || 0));

      const symLabels = symptomMaster;              // ‚úÖ ‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß
      const symValues = symptomMaster.map(n => Number(symMap[n] || 0));

      const maxDept = deptValues.length ? Math.max(...deptValues) : 0;
      const maxSym = symValues.length ? Math.max(...symValues) : 0;

      // 3) ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ó‡πà‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      const deptBar = Math.max(10, Math.min(24, Math.floor(360 / deptLabels.length)));
      const symBar = Math.max(10, Math.min(24, Math.floor(360 / symLabels.length)));

      if (deptChart) deptChart.destroy();
      if (diseaseChart) diseaseChart.destroy();

      // ‚úÖ ‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô / ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• = 0)
      deptChart = new Chart(document.getElementById("deptChart"), {
        type: "bar",
        data: {
          labels: deptLabels,
          datasets: [{
            data: deptValues,
            backgroundColor: "#A7C7E7",
            barThickness: deptBar,
            maxBarThickness: deptBar
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              beginAtZero: true,
              suggestedMax: maxDept > 0 ? (maxDept + 1) : 1,
              ticks: { stepSize: 1, precision: 0, font: { size: 18 } }
            },
            y: { ticks: { font: { size: 20 } } }
          }
        }
      });

      // ‚úÖ ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° / ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• = 0)
      diseaseChart = new Chart(document.getElementById("diseaseChart"), {
        type: "bar",
        data: {
          labels: symLabels,
          datasets: [{
            data: symValues,
            backgroundColor: "#B5EAD7",
            barThickness: symBar,
            maxBarThickness: symBar
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              beginAtZero: true,
              suggestedMax: maxSym > 0 ? (maxSym + 1) : 1,
              ticks: { stepSize: 1, precision: 0, font: { size: 18 } }
            },
            y: { ticks: { font: { size: 20 } } }
          }
        }
      });
    }



    /* ================== YEAR CHART ================== */
    let yearDeptChart = null;
    let yearDiseaseChart = null;

    async function renderYearCharts(year) {
      // ----- master list ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -----
      const deptMaster = [
        "‡∏≠‡∏™‡∏£", "‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö", "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£", "‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°", "‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£",
        "‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•", "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£", "‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå"
      ];

      const symptomMaster = [
        "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à", "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á", "‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á",
        "‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°", "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå", "‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å", "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏", "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
      ];

      // map ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© -> ‡πÑ‡∏ó‡∏¢ (‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
      const symptomAliasToThai = {
        "respiratory": "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à",
        "digestive": "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
        "muscle": "‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠",
        "brain": "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á",
        "skin": "‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á",
        "internal medicine": "‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°",
        "urinary": "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢",
        "reproductive": "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå",
        "eye ear mouth": "‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å",
        "accident": "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏",
        "other": "‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
        "supply": "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå",
        "supplies": "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå",
        "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå": "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå"
      };

      function normKey(s) {
        return String(s || "").trim().toLowerCase().replace(/\s+/g, " ");
      }
      function toThaiSymptom(name) {
        const k = normKey(name);
        return symptomAliasToThai[k] || String(name || "").trim();
      }
      function normDeptName(s) {
        return String(s || "")
          .trim()
          .replace(/\./g, "")     // "‡∏≠‡∏™‡∏£." -> "‡∏≠‡∏™‡∏£"
          .replace(/\s+/g, " ");
      }

      // 1) ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API
      let deptData = [];
      let symptomData = [];

      try {
        const r1 = await fetch(`/api/dashboard/dept_year?year=${year}`);
        deptData = await r1.json();
      } catch (e) {
        console.error("‡πÇ‡∏´‡∏•‡∏î dept ‡∏õ‡∏µ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
        deptData = [];
      }

      try {
        const r2 = await fetch(`/api/dashboard/symptom_year?year=${year}`);
        symptomData = await r2.json();
      } catch (e) {
        console.error("‡πÇ‡∏´‡∏•‡∏î symptom ‡∏õ‡∏µ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
        symptomData = [];
      }

      // 2) map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö master (‡πÑ‡∏°‡πà‡∏°‡∏µ = 0)
      const deptMap = {};
      (deptData || []).forEach(x => {
        const k = normDeptName(x.name);
        if (!k) return;
        deptMap[k] = (deptMap[k] || 0) + Number(x.total || 0);
      });

      const symMap = {};
      (symptomData || []).forEach(x => {
        const thai = toThaiSymptom(x.name);
        const k = String(thai || "").trim();
        if (!k) return;
        symMap[k] = (symMap[k] || 0) + Number(x.total || 0);
      });

      const deptLabels = deptMaster.map(normDeptName);
      const deptValues = deptMaster.map(n => Number(deptMap[n] || 0));

      const symLabels = symptomMaster;
      const symValues = symptomMaster.map(n => Number(symMap[n] || 0));

      const maxDept = deptValues.length ? Math.max(...deptValues) : 0;
      const maxSym = symValues.length ? Math.max(...symValues) : 0;

      const deptBar = Math.max(10, Math.min(24, Math.floor(360 / deptLabels.length)));
      const symBar = Math.max(10, Math.min(24, Math.floor(360 / symLabels.length)));

      if (yearDeptChart) yearDeptChart.destroy();
      if (yearDiseaseChart) yearDiseaseChart.destroy();

      yearDeptChart = new Chart(document.getElementById("yearDeptChart"), {
        type: "bar",
        data: {
          labels: deptLabels,
          datasets: [{
            data: deptValues,
            backgroundColor: "#A7C7E7",
            barThickness: deptBar,
            maxBarThickness: deptBar
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              beginAtZero: true,
              suggestedMax: maxDept > 0 ? (maxDept + 1) : 1,
              ticks: { stepSize: 1, precision: 0, font: { size: 18 } }
            },
            y: { ticks: { font: { size: 20 } } }
          }
        }
      });

      yearDiseaseChart = new Chart(document.getElementById("yearDiseaseChart"), {
        type: "bar",
        data: {
          labels: symLabels,
          datasets: [{
            data: symValues,
            backgroundColor: "#B5EAD7",
            barThickness: symBar,
            maxBarThickness: symBar
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              beginAtZero: true,
              suggestedMax: maxSym > 0 ? (maxSym + 1) : 1,
              ticks: { stepSize: 1, precision: 0, font: { size: 18 } }
            },
            y: { ticks: { font: { size: 20 } } }
          }
        }
      });
    }



    /* ================== DRUG & SUPPLY TABLE ================== */

    /* ===== ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢) ===== */
    const drugs = [
      "0.1%TA Cream",
      "Acyclovir",
      "Air-X",
      "Amoxy",
      "Antacid",
      "B1,6,12",
      "Balm",
      "Bisolvon",
      "Brufen(400)",
      "Buscopan",
      "CA-R-Bon",
      "Calamine lotion",
      "CPM",
      "Diasgest",
      "Dimen",
      "Hista oph",
      "Ibuprofen",
      "K milk120cc",
      "K-milk",
      "Kenalog",
      "Loratadine",
      "Motilium",
      "M.car",
      "M.tusis",
      "Mybacin",
      "Mycozol",
      "Mydoclam",
      "Norflox",
      "Norgesic",
      "Ointment",
      "Op Sar",
      "ORS",
      "Paracetamol(500)",
      "Plaster",
      "Ponstan(500)",
      "Silver cream",
      "Zyetec",
      "‡∏¢‡∏≤‡∏´‡∏≠‡∏°",
      "‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ"
    ];

    /* ===== ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå ===== */
    const supplies = [
      "0.9%NSS",
      "70%Alcohol",
      "Amora",
      "Betadine",
      "EB:2\"",
      "EB:3\"",
      "Eyepad",
      "Gouze",
      "Grove Dispose",
      "Mask",
      "Sofatulle",
      "Transpore",
      "‡∏Å‡∏£‡∏£‡πÑ‡∏Å‡∏£",
      "‡∏Å‡πâ‡∏ß‡∏¢‡∏≤‡∏ô‡πâ‡∏≥/‡πÅ‡∏Å‡πâ‡∏ß‡∏¢‡∏≤‡πÄ‡∏°‡πá‡∏î",
      "‡πÄ‡∏Ç‡πá‡∏°‡∏Å‡∏•‡∏±‡∏î",
      "‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏îHTC",
      "‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏îMET",
      "‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏≥‡πÅ‡∏ú‡∏• D/S",
      "‡∏ñ‡πâ‡∏ß‡∏¢‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤",
      "‡∏ñ‡∏∏‡∏á‡∏¢‡∏≤‡∏á‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢",
      "‡∏õ‡∏£‡∏≠‡∏ó‡∏ß‡∏±‡∏î‡πÑ‡∏Ç‡πâ",
      "‡∏õ‡∏≤‡∏Å‡∏Ñ‡∏∑‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏π‡πà",
      "‡∏ú‡πâ‡∏≤‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°",
      "‡∏™‡∏≤‡∏¢02 Canula",
      "‡∏™‡∏≤‡∏¢02 Mask with Bag",
      "‡∏™‡∏≤‡∏¢‡∏¢‡∏≤‡∏á‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î",
      "‡∏´‡∏•‡∏≠‡∏î‡∏´‡∏¢‡∏î‡∏¢‡∏≤",
      "‡πÑ‡∏°‡πâ‡∏Å‡∏î‡∏•‡∏¥‡πâ‡∏ô",
      "‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ"
    ];

    /* ===== ‡∏£‡∏ß‡∏° + ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞ ===== */
    const allItems = [...new Set([...drugs, ...supplies])].sort();

    function norm(s) {
      if (!s) return "";
      s = String(s).trim().toLowerCase();
      s = s.replace(/[‚Äì‚Äî‚àí]/g, "-");  // dash ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö -> "-"
      s = s.replace(/\s+/g, " ");    // ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≠‡∏ô -> 1 ‡∏ä‡πà‡∏≠‡∏á
      return s;
    }

    /* ===== ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ===== */
    /* ===== ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏Ñ‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ===== */
    async function loadDrugTable(month = currentMonth, year = currentYear) {
      const tbody = document.getElementById("drugTable");
      tbody.innerHTML = "";

      let data = {};
      try {
        const res = await fetch(`/api/dashboard/drug_summary?year=${year}&month=${month}`);
        data = await res.json();
      } catch (e) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", e);
        data = {};
      }

      const dataNorm = {};
      Object.keys(data || {}).forEach(k => {
        dataNorm[norm(k)] = data[k];
      });

      allItems.forEach(name => {
        const item = dataNorm[norm(name)] || { used: 0, remain: 0, has_used: false, has_lot: false };

        const usedText = item.has_used ? item.used : "-";
        const remainText = item.has_lot ? item.remain : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";

        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td>${name}</td>
      <td style="text-align:center;">${usedText}</td>
      <td style="text-align:center;">${remainText}</td>
    `;
        tbody.appendChild(tr);
      });
    }


    let top5MonthChart = null;
    let yearTop5Chart = null;


    async function renderTop5Month(month) {
      let data = [];
      try {
        const res = await fetch(`/api/dashboard/top5_month?year=${currentYear}&month=${month}`);
        data = await res.json();
      } catch (e) {
        console.error("‡πÇ‡∏´‡∏•‡∏î Top5 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
        data = [];
      }

      const ctx = document.getElementById("monthTop5Chart");

      if (top5MonthChart) top5MonthChart.destroy();

      const labels = (data || []).map(d => d.name);
      const values = (data || []).map(d => d.total);

      if (!labels.length) {
        top5MonthChart = new Chart(ctx, {
          type: "bar",
          data: { labels: ["‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"], datasets: [{ data: [0] }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, title: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
        return;
      }


      top5MonthChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢",
            data: values,
            backgroundColor: ['#A7C7E7', '#B5EAD7', '#FFDAC1', '#E2CFEA', '#CDB4DB'], // ‚úÖ ‡∏™‡∏µ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô 5 ‡πÅ‡∏ó‡πà‡∏á
            borderWidth: 0,
            maxBarThickness: 70,   // ‚úÖ ‡∏Å‡∏±‡∏ô‡πÅ‡∏ó‡πà‡∏á‡∏≠‡πâ‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô
            categoryPercentage: 0.7,
            barPercentage: 0.8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,   // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏≤‡∏Å .chart-wrap-top5
          plugins: {
            legend: { display: false },
            title: { display: false }    // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
          },
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      });


    }


    async function renderYearTop5() {
      let data = [];
      try {
        const res = await fetch(`/api/dashboard/top5_year?year=${currentYear}`);
        data = await res.json();
      } catch (e) {
        console.error("‡πÇ‡∏´‡∏•‡∏î Top5 ‡∏õ‡∏µ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
        data = [];
      }

      const ctx = document.getElementById("yearTop5Chart");
      if (yearTop5Chart) yearTop5Chart.destroy();

      const labels = (data || []).map(d => d.name);
      const values = (data || []).map(d => d.total);

      if (!labels.length) {
        yearTop5Chart = new Chart(ctx, {
          type: "bar",
          data: { labels: ["‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"], datasets: [{ data: [0] }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, title: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
        return;
      }

      yearTop5Chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢",
            data: values,
            backgroundColor: ['#A7C7E7', '#B5EAD7', '#FFDAC1', '#E2CFEA', '#CDB4DB'],
            borderWidth: 0,
            maxBarThickness: 70,
            categoryPercentage: 0.7,
            barPercentage: 0.8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, title: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }


    // ‚úÖ init ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ dashboard
    document.addEventListener("DOMContentLoaded", function () {
      setupScroll("top5");
      currentMonth = 1;
      loadDrugTable(currentMonth, currentYear);  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    });

  </script>

  </div><!-- container ‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÜ -->
  <div class="footer">¬© 2025 Safety Officer, CPF Khon Kaen Feedmill</div>
</body>

</html>