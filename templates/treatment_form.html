<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --blue: #2196f3;
      --blue-dark: #1976d2;
      --border: #cfd8dc;
      --bg: #f4f6f8;
    }

    * {
      box-sizing: border-box;
    }

    .header {
      font-size: 16px;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: #f4f6f8;
      margin: 0;
    }

    .container {
      font-size: 24px;
    }

    /* ================= HEADER ================= */
    .header {
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 40px;

      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #5b2c83;
    }

    .header-left i {
      font-size: 26px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .logout-btn {
      background: #ff6b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    /* ===== container ===== */
    .container {
      max-width: 1500px;
      background: #fff;
      margin: 40px auto;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      position: relative;
    }

    /* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô waste.html) ===== */
    .back-menu-btn {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      font-size: 20px;
      border-radius: 8px;
      text-decoration: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: 0.2s;
    }

    .back-menu-btn:hover {
      background: #218838;
    }

    .top-bar {
      text-align: left;
    }

    /* ===== heading ===== */
    h2 {
      text-align: center;
      margin-bottom: 35px;
      font-size: 32px;
      font-weight: 700;
      color: #0d47a1;
    }

    /* ===== label ===== */
    label {
      font-weight: 600;
      display: block;
      margin-top: 20px;
      margin-bottom: 6px;
    }

    /* ===== input / select / textarea ===== */
    input,
    textarea,
    select {
      width: 100%;
      padding: 14px 18px;
      font-size: 24px;
      box-sizing: border-box;
      border-radius: 18px;
      border: 1px solid var(--border);
      font-family: 'Sarabun', sans-serif;
      transition: .2s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.25);
    }

    /* ===== inline ===== */
    .inline {
      display: flex;
      gap: 30px;
      align-items: center;
      margin-top: 10px;
    }

    /* ===== add / submit buttons ===== */
    button {
      font-family: 'Sarabun', sans-serif;
      font-size: 22px;
      padding: 12px 20px;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      transition: .2s;
    }

    button[type="submit"],
    .add-btn {
      background: var(--blue);
      color: #fff;
    }

    button[type="submit"]:hover,
    .add-btn:hover {
      background: var(--blue-dark);
    }

    /* ===== medicine add row ===== */
    .medicine-row button {
      background: var(--blue);
      color: #fff;
    }

    /* ===== table ===== */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
      border-radius: 18px;
      overflow: hidden;
    }

    th {
      background: linear-gradient(135deg, #bbdefb, #90caf9);
      color: #0d47a1;
      padding: 16px;
      font-weight: 700;
      text-align: center;
    }

    td {
      padding: 14px;
      text-align: center;
      border-top: 1px solid #e0e0e0;
    }

    tr:hover td {
      background: #f5faff;
    }

    /* ===== delete button ===== */
    table button {
      background: #ef5350;
      color: #fff;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      padding: 0;
    }

    /* ===== radio ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô ===== */
    .inline input[type="radio"] {
      transform: scale(1.8);
      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î (1.5 ‚Äì 2.0 ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ä‡∏≠‡∏ö) */
      margin-right: 8px;
      cursor: pointer;
    }

    .inline label {
      display: inline-flex;
      /* ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç */
      align-items: center;
      gap: 8px;
      font-size: 24px;
      white-space: nowrap;
      /* ‚≠ê ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
    }

    /* ================= FOOTER ================= */
    .footer {
      width: 100%;
      background: #dcdcdc;
      text-align: center;
      padding: 18px;
      font-size: 14px;
      color: #555;
      margin-top: 60px;
    }
  </style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>

    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <div class="container">
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π -->
    <div class="top-bar">
      <a href="/menu" class="back-menu-btn">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π</a>
    </div>

    <h2>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>

    <form method="post">

      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
      <input type="date" name="visit_date" required>

      <label>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
      <input type="text" name="patient_name" required>

      <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
      <select name="department">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
        <option>‡∏≠‡∏™‡∏£.</option>
        <option>‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
        <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</option>
        <option>‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°</option>
        <option>‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
        <option>‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•</option>
        <option>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</option>
        <option>‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£</option>
        <option>‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
        <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>

      <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
      <select id="symptom_group" name="symptom_group">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
        <option value="respiratory">‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à</option>
        <option value="digestive">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
        <option value="muscle">‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠</option>
        <option value="brain">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á</option>
        <option value="skin">‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á</option>
        <option value="medicine">‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</option>
        <option value="urinary">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢</option>
        <option value="reproductive">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
        <option value="eye">‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å</option>
        <option value="throat">‡∏Ñ‡∏≠</option>
        <option value="nose">‡∏à‡∏°‡∏π‡∏Å</option>
        <option value="wound">‡∏ó‡∏≥‡πÅ‡∏ú‡∏•</option>
        <option value="work_accident">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏á‡∏≤‡∏ô</option>
        <option value="nonwork_accident">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏ô‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</option>
        <option value="supply">‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</option>
        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>

      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
      <textarea name="symptom_detail" rows="3"></textarea>

      <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</label>

      <div style="display:flex; gap:10px; align-items:center;" class="medicine-row">

        <select id="medicine_select" style="flex:3;">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
        </select>

        <input type="text" id="medicine_other" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå" style="flex:3; display:none;">

        <select id="lot_select" style="flex:2;">
          <option value="">Lot</option>
        </select>

        <input type="number" id="qty_input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" style="flex:1;">

        <button type="button" class="add-btn" onclick="addMedicine()" style="flex:1;">
          ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
        </button>

      </div>

      <table id="medicine_table">
        <tr>
          <th>‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</th>
          <th>Lot</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th>‡∏•‡∏ö</th>
        </tr>
      </table>

      <label>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
      <div class="inline">
        <label><input type="radio" name="allergy" value="0" checked> ‡πÑ‡∏°‡πà‡πÅ‡∏û‡πâ</label>
        <label><input type="radio" name="allergy" value="1"> ‡πÅ‡∏û‡πâ</label>
      </div>

      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
      <textarea name="allergy_detail" rows="2"></textarea>

      <!-- ===== ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå ===== -->
      <label style="margin-top:30px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>

      <label style="font-weight:500;">
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
      </label>

      <div class="inline">
        <label>
          <input type="radio" name="occupational_disease" value="0" checked>
          ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢
        </label>
        <label>
          <input type="radio" name="occupational_disease" value="1">
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢
        </label>
      </div>

      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>
      <textarea name="doctor_opinion" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå"></textarea>


      <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</button>

      <input type="hidden" name="medicine_json" id="medicine_json">

    </form>
  </div>

  <script>
    /* ===============================
       ELEMENTS
    ================================ */
    const symptom = document.getElementById('symptom_group');
    const medSelect = document.getElementById('medicine_select');
    const medOther = document.getElementById('medicine_other');
    const qtyInput = document.getElementById('qty_input');
    const lotSelect = document.getElementById('lot_select');
    const table = document.getElementById('medicine_table');
    const form = document.querySelector("form");

    let medicines = [];

    /* ===============================
       DATA
    ================================ */
    const medicineData = {
      respiratory: ['Amoxy', 'Bisolvon', 'Mybacin', 'Loratadine', 'Zyetec', 'M.tusis'],
      digestive: ['Air-x', 'K milk120cc', 'Buscopan', 'Diasgest', 'M.car', 'ORS', 'Paracetamol(500)', 'Motilium', 'K-milk', '‡∏¢‡∏≤‡∏´‡∏≠‡∏°', 'CA-R-Bon'],
      muscle: ['Balm', 'Mydoclam', 'Norgesic'],
      brain: ['B1,6,12', 'Dimen', 'ORS', 'Paracetamol(500)'],
      skin: ['Acyclovir', 'CPM', 'Loratadine', 'Zyetec', '0.1%TA Cream', 'Mycozol', 'Silver cream', 'Calamine lotion'],
      urinary: ['Paracetamol(500)', 'Norflox'],
      reproductive: ['Ponstan(500)'],
      eye: ['Hista oph', 'Op Sar', 'Ointment', 'Brufen(400)', 'Kenalog'],
      wound: ['Plaster', '‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ'],
      supply: [
        '‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ', 'EB:3', 'EB:2', 'Mask', 'Grove Dispose', 'Eyepad', 'Transpore',
        'Sofatulle', '‡πÑ‡∏°‡πâ‡∏Å‡∏î‡∏•‡∏¥‡πâ‡∏ô', 'Gouze', 'Betadine', '70%Alcohol', '0.9%NSS', 'Amora',
        '‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏îMET', '‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏îHTC', '‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏≥‡πÅ‡∏ú‡∏• D/S', '‡∏Å‡∏£‡∏£‡πÑ‡∏Å‡∏£',
        '‡∏ñ‡πâ‡∏ß‡∏¢‡∏¢‡∏≤', '‡πÄ‡∏Ç‡πá‡∏°‡∏Å‡∏•‡∏±‡∏î', '‡∏õ‡∏£‡∏≠‡∏ó‡∏ß‡∏±‡∏î‡πÑ‡∏Ç‡πâ', '‡∏õ‡∏≤‡∏Å‡∏Ñ‡∏µ‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏π‡πà', '‡∏ú‡πâ‡∏≤‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°',
        '‡∏™‡∏≤‡∏¢‡∏¢‡∏≤‡∏á‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î', '‡∏´‡∏•‡∏≠‡∏î‡∏´‡∏¢‡∏î‡∏¢‡∏≤', '‡∏ñ‡πâ‡∏ß‡∏¢‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤', '‡∏™‡∏≤‡∏¢02 Canula',
        '‡∏™‡∏≤‡∏¢02 Mask with Bag', '‡∏ñ‡∏∏‡∏á‡∏¢‡∏≤‡∏á‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢'
      ]
    };

    /* ===============================
       CHANGE SYMPTOM
    ================================ */
    symptom.addEventListener('change', () => {
      medSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';
      medSelect.style.display = 'block';
      medOther.style.display = 'none';

      if (symptom.value === 'other') {
        medSelect.style.display = 'none';
        medOther.style.display = 'block';
        return;
      }

      (medicineData[symptom.value] || []).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        medSelect.appendChild(opt);
      });
    });

    /* ===============================
       LOAD LOT
    ================================ */
    medSelect.addEventListener('change', async () => {
      lotSelect.innerHTML = '<option value="">Lot</option>';
      if (!medSelect.value) return;

      // ‚úÖ ‡πÉ‡∏ä‡πâ medicine_id ‡πÄ‡∏™‡∏°‡∏≠ (‡∏ó‡∏±‡πâ‡∏á‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå)
      const res = await fetch(
        `/api/medicine_id?name=${encodeURIComponent(medSelect.value)}`
      );
      const dataId = await res.json();
      const medId = dataId.medicine_id;

      if (!medId) {
        console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö medicine_id:", medSelect.value);
        return;
      }

      const lotRes = await fetch(
        `/api/medicine_lots?medicine_id=${medId}`
      );
      const data = await lotRes.json();

      if (!data.lots || data.lots.length === 0) {
        console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö LOT:", medSelect.value);
        return;
      }

      data.lots.forEach(lot => {
        const opt = document.createElement('option');
        opt.value = lot.id;
        opt.textContent = `${lot.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${lot.remain})`;
        opt.dataset.price = lot.price || 0;
        lotSelect.appendChild(opt);
      });
    });



    /* ===============================
       ADD MEDICINE
    ================================ */
    function addMedicine() {
      if (!medSelect.value || !lotSelect.value || !qtyInput.value) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        return;
      }

      const selected = lotSelect.options[lotSelect.selectedIndex];
      const remainText = selected.textContent.match(/‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠\s+(\d+)/);
      const remain = remainText ? parseInt(remainText[1], 10) : null;

      if (remain !== null && parseInt(qtyInput.value, 10) > remain) {
        alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô Lot ‡∏ô‡∏µ‡πâ");
        return;
      }

      medicines.push({
        name: medSelect.value,
        lot: lotSelect.options[lotSelect.selectedIndex].text,
        lot_id: lotSelect.value,
        qty: qtyInput.value
      });

      const row = table.insertRow();
      row.insertCell(0).innerText = medSelect.value;
      row.insertCell(1).innerText = lotSelect.options[lotSelect.selectedIndex].text;
      row.insertCell(2).innerText = qtyInput.value;
      row.insertCell(3).innerText = lotSelect.options[lotSelect.selectedIndex].dataset.price || "-";
      row.insertCell(4).innerHTML = `<button type="button" onclick="this.closest('tr').remove()">‚ùå</button>`;

      qtyInput.value = "";
      lotSelect.innerHTML = '<option value="">Lot</option>';
    }

    /* ===============================
       SUBMIT
    ================================ */
    form.addEventListener("submit", e => {
      if (medicines.length === 0) {
        e.preventDefault();
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
        return;
      }
      document.getElementById("medicine_json").value = JSON.stringify(medicines);
    });
  </script>

  <!-- ===== FOOTER ===== -->
  <div class="footer">
    ¬© 2025 Safety Officer, CPF Khon Kaen Feedmill
  </div>
</body>

</html>