<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }

    .header {
      font-size: 16px;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: #f4f6f8;
      margin: 0;
    }

    .container {
      font-size: 24px;
    }

    /* ================= HEADER ================= */
    .header {
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 40px;

      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #5b2c83;
    }

    .header-left i {
      font-size: 26px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .logout-btn {
      background: #ff6b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    .box {
      position: relative;
      background: #fff;
      padding: 40px;
      border-radius: 14px;
      max-width: 1500px;
      margin: 40px auto;
      box-shadow: 0 8px 25px rgba(0, 0, 0, .25);
    }

    .save-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: #28a745;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 18px;
    }

    h2 {
      text-align: center;
      font-size: 32px
    }

    .search {
      width: 100%;
      padding: 14px;
      font-size: 22px;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    th {
      background: #90CAF9
    }

    .action-btn {
      cursor: pointer;
      font-size: 22px;
      margin: 0 6px;
    }

    .page {
      display: none
    }

    .page.active {
      display: block
    }

    .back-btn {
      margin-top: 20px;
      padding: 12px 20px;
      font-size: 20px;
    }

    /* ================= FOOTER ================= */
    .footer {
      width: 100%;
      background: #dcdcdc;
      text-align: center;
      padding: 18px;
      font-size: 14px;
      color: #555;
      margin-top: 60px;
    }
  </style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>

    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <div class="container">

    <!-- ================= LIST ================= -->
    <div id="page-list" class="box page active">
      <a href="/medical_certificate" class="save-btn">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
      <h2>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</h2>

      <input class="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" onkeyup="filterTable(this.value)">

      <table id="recordTable"></table>
    </div>

    <!-- ================= VIEW ================= -->
    <div id="page-view" class="box page">
      <a href="#" class="save-btn" onclick="back()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</a>
      <h2>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</h2>
      <div id="viewBox"></div>
    </div>

    <script>
      /* ================= CONFIG ================= */
      const PART1_FIELDS = {
        title: "‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤",
        fullname: "‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
        address: "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà",
        disease: "‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß",
        disease_detail: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏£‡∏Ñ",
        accident: "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î",
        accident_detail: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏",
        hospital: "‡πÄ‡∏Ñ‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•",
        hospital_detail: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤",
        other_history: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"
      };

      const PART2_FIELDS = {
        doctor_name: "‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå",
        hospital_name: "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à",
        weight: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å",
        height: "‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á",
        bp: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô",
        pulse: "‡∏ä‡∏µ‡∏û‡∏à‡∏£",
        body_status: "‡∏™‡∏†‡∏≤‡∏û‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå",
        body_detail: "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå",
        work_result: "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"
      };

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server (Jinja2 template)
      const records = {{ records | tojson | safe }};

      /* ================= PAGE ================= */
      function openPage(p) {
        document.querySelectorAll(".page").forEach(x => x.classList.remove("active"));
        document.getElementById("page-" + p).classList.add("active");
      }
      function back() { openPage("list"); }

      /* ================= TABLE ================= */
      function loadTable(list = records) {
        let html = `
    <tr>
      <th>#</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    </tr>
  `;

        list.forEach((r, i) => {
          const recordId = r.id;  // ‡πÉ‡∏ä‡πâ ID ‡∏à‡∏≤‡∏Å Google Sheets
          html += `
      <tr>
        <td>${i + 1}</td>
        <td>${r.fullname || "-"}</td>
        <td>${r.requester_date || r.created_at || "-"}</td>
        <td>
          <span class="action-btn" onclick="viewRecord(${i})">üëÅÔ∏è</span>
          <span class="action-btn" onclick="editRecord(${recordId})">‚úèÔ∏è</span>
          <span class="action-btn" onclick="deleteRecord(${recordId})">üóëÔ∏è</span>
        </td>
      </tr>
    `;
        });

        recordTable.innerHTML = html;
      }
      loadTable();

      /* ================= VIEW ================= */
      function viewRecord(i) {
        const r = records[i];
        if (!r) return;

        let html = `
    <h3>üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</h3>
    <table>
      <tr><td>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</td><td>${r.title || "-"}</td></tr>
      <tr><td>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</td><td>${r.fullname || "-"}</td></tr>
      <tr><td>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</td><td>${r.address || "-"}</td></tr>
      <tr><td>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</td><td>${r.disease || "-"} ${r.disease_detail || ""}</td></tr>
      <tr><td>‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</td><td>${r.accident || "-"} ${r.accident_detail || ""}</td></tr>
      <tr><td>‡πÄ‡∏Ñ‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</td><td>${r.hospital || "-"} ${r.hospital_detail || ""}</td></tr>
      <tr><td>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</td><td>${r.other_history || "-"}</td></tr>
      <tr><td>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</td><td>${r.requester_sign || "-"}</td></tr>
      <tr><td>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</td><td>${r.requester_date || "-"}</td></tr>
    </table>

    <h3>üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå</h3>
    <table>
  `;

        Object.entries(PART2_FIELDS).forEach(([k, l]) => {
          let value = r[k] || "-";
          html += `<tr><td>${l}</td><td>${value}</td></tr>`;
        });

        html += `</table>`;

        viewBox.innerHTML = html;
        openPage("view");
      }

      /* ================= EDIT ================= */
      function editRecord(id) {
        // ‡∏™‡πà‡∏á ID ‡∏ú‡πà‡∏≤‡∏ô URL ‡πÅ‡∏ó‡∏ô localStorage
        window.location.href = `/medical_certificate/edit/${id}`;
      }

      /* ================= DELETE ================= */
      async function deleteRecord(id) {
        if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) {
          try {
            const response = await fetch(`/api/medical_certificate/delete/${id}`, {
              method: "DELETE"
            });
            const result = await response.json();

            if (result.success) {
              alert("‚úî ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
              window.location.reload();  // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
            } else {
              alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (result.message || "Unknown error"));
            }
          } catch (error) {
            console.error("Error deleting certificate:", error);
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: " + error.message);
          }
        }
      }

      /* ================= SEARCH ================= */
      function filterTable(q) {
        q = q.toLowerCase();
        const filtered = records.filter(r =>
          (r.fullname || "").toLowerCase().includes(q) ||
          (r.requester_date || "").includes(q)
        );
        loadTable(filtered);
      }
    </script>

    <!-- ===== FOOTER ===== -->
    <div class="footer">
      ¬© 2025 Safety Officer, CPF Khon Kaen Feedmill
    </div>
</body>

</html>